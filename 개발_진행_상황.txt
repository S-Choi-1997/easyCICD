================================================================================
Lightweight CI/CD - 개발 진행 상황
================================================================================
최종 업데이트: 2026-01-08

================================================================================
✅ 완료된 작업
================================================================================

Phase 1: Agent 기본 구조 (완료)
----------------------------------
✅ Rust 프로젝트 구조 설정 (Cargo.toml, Dockerfile)
✅ SQLite 데이터베이스 연동 (sqlx 0.8)
✅ 데이터베이스 스키마 및 마이그레이션
   - projects, builds 테이블
   - Slot enum (Blue/Green)
   - BuildStatus enum (Queued, Building, Deploying, Success, Failed)
✅ 이벤트 버스 시스템 (tokio broadcast channel)
✅ AppState (공유 상태 관리)
✅ Docker API 연동 (bollard 0.19)
✅ 로깅 설정 (tracing)

Phase 2: 빌드 시스템 (완료)
----------------------------------
✅ Docker 빌드 컨테이너 실행
   - agent/src/docker/client.rs - Docker API 래퍼
   - 빌드 이미지에서 컨테이너 생성 및 실행
   - 로그 수집 (stdout/stderr)

✅ 빌드 실행기 (agent/src/build/executor.rs)
   - Git clone/pull (workspace 관리)
   - 빌드 컨테이너 실행
   - 로그 파일 저장 (/data/logs/)
   - 이벤트 발행 (BuildStatus 변경)

✅ 배포 시스템 (agent/src/build/deployer.rs)
   - 런타임 컨테이너 생성
   - Health Check (10회 재시도, 5초 간격)
   - Blue/Green 슬롯 전환
   - 이전 컨테이너 정리

✅ 빌드 큐 (agent/src/build/worker.rs)
   - 프로젝트별 순차 빌드 (동일 프로젝트 빌드는 순차)
   - 프로젝트 간 병렬 빌드
   - 백그라운드 워커 스레드

✅ 캐시 시스템
   - 패키지 매니저별 캐시 경로 매핑
   - gradle → /root/.gradle
   - maven → /root/.m2
   - npm → /root/.npm
   - pip → /root/.cache/pip
   - cargo → /usr/local/cargo/registry

✅ 중간 우선순위 개선사항
   - Glob 패턴 지원 (globset 크레이트)
   - 수동 빌드 트리거 API (POST /api/projects/:id/builds)
   - 프로젝트 삭제 API (DELETE /api/projects/:id)
   - Docker 이미지 pull 에러 감지 및 전파

Phase 3: API 서버 (완료)
----------------------------------
✅ Webhook 핸들러 (agent/src/api/webhook.rs)
   - GitHub Webhook 수신
   - HMAC-SHA256 서명 검증
   - Path Filter Glob 패턴 매칭
   - 빌드 생성 및 큐 등록

✅ REST API (agent/src/api/)
   - GET/POST /api/projects - 프로젝트 CRUD
   - GET /api/projects/:id - 프로젝트 조회
   - DELETE /api/projects/:id - 프로젝트 삭제 (리소스 정리 포함)
   - POST /api/projects/:id/builds - 수동 빌드 트리거
   - GET /api/builds - 빌드 목록 조회 (필터링 지원)
   - GET /api/builds/:id - 빌드 상세 조회

✅ WebSocket 서버 (agent/src/api/ws.rs)
   - 구독/구독 해제 메시지 처리
   - 클라이언트 연결 관리 (WsConnections)

✅ WebSocket 브로드캐스터 (agent/src/ws_broadcaster.rs)
   - 이벤트 버스 → WebSocket 클라이언트
   - 실시간 상태 업데이트

Phase 4: 리버스 프록시 (완료)
----------------------------------
✅ Path-based 라우팅 (agent/src/proxy/router.rs)
   - /{project_name}/** → 활성 슬롯 컨테이너
   - HTTP 요청 헤더 전달
   - Hyper 기반 프록시
   - Gateway IP를 통한 컨테이너 간 통신

Phase 5: Web UI (완료)
----------------------------------
✅ Svelte 프론트엔드
   - frontend-svelte/ 디렉토리
   - Vite 빌드 시스템
   - svelte-spa-router로 SPA 라우팅

✅ Dashboard 페이지 (src/routes/Dashboard.svelte)
   - 프로젝트 목록 표시
   - 상태 배지 (Running/Not Deployed)
   - Trigger Build 버튼
   - Delete 버튼
   - View Builds 링크

✅ Setup 페이지 (src/routes/Setup.svelte)
   - 프로젝트 생성 폼
   - 빌드 설정 (이미지, 캐시, 명령어)
   - 런타임 설정 (이미지, 명령어, health check)
   - 폼 검증

✅ Build History 페이지 (src/routes/BuildHistory.svelte)
   - 프로젝트 정보 표시
   - 빌드 목록 (번호, 상태, commit, 시간)
   - 빌드 상세 보기
   - Trigger Build 버튼

✅ 스타일링 (src/app.css)
   - 모던한 UI 디자인
   - 상태별 색상 구분
   - 반응형 레이아웃
   - 번들 크기: 20.76 kB (gzip)

✅ Static 파일 서빙
   - tower-http ServeDir로 /frontend 디렉토리 서빙
   - main.rs에서 라우팅 설정

Phase 6: GitHub 통합 (완료)
----------------------------------
✅ GitHub OAuth 연동
   - PAT 토큰 저장 및 암호화
   - 레포지토리 목록 조회
   - 브랜치 목록 조회
   - 파일 트리 탐색

✅ 프로젝트 자동 감지 (agent/src/github/detector.rs)
   - Node.js 프로젝트 (package.json)
   - Python 프로젝트 (requirements.txt, setup.py)
   - Rust 프로젝트 (Cargo.toml)
   - Go 프로젝트 (go.mod)
   - Java 프로젝트 (pom.xml, build.gradle)
   - Dockerfile 기반 프로젝트

✅ 워크플로우 자동 감지
   - .github/workflows/*.yml 파일 분석
   - 빌드 명령어 추출
   - 런타임 설정 추출

Phase 7: 네트워크 통신 개선 (완료) 🆕
----------------------------------
✅ Docker 네트워크 아키텍처 개선
   - Gateway IP 자동 감지 (agent/src/docker/client.rs:60-72)
   - Runtime 컨테이너를 easycicd_easycicd 네트워크에 연결
   - 멀티 네트워크 지원 (bridge + easycicd_easycicd)

✅ 헬스체크 통신 개선
   - localhost → Gateway IP (172.19.0.1) 사용
   - 네트워크 격리 문제 해결
   - 안정적인 컨테이너 간 통신

✅ 리버스 프록시 통신 개선
   - AppState에 gateway_ip 추가
   - 프록시 라우팅에서 Gateway IP 사용
   - Cloudflare Tunnel 연동 지원

주요 기술 스택
----------------------------------
백엔드:
- Rust 1.92
- Axum 0.8 (웹 프레임워크)
- Tokio (비동기 런타임)
- SQLx 0.8 (데이터베이스)
- Bollard 0.19 (Docker API)
- Hyper 1.0 (리버스 프록시)
- tokio-tungstenite (WebSocket)

프론트엔드:
- Svelte 4
- Vite (빌드 도구)
- svelte-spa-router (라우팅)
- Vanilla CSS

인프라:
- Docker (DOOD: Docker-outside-of-Docker)
- SQLite (데이터베이스)
- Cloudflare Tunnel (외부 접근)

주요 수정사항 및 버그 픽스
----------------------------------
1. Git을 Dockerfile 런타임에 추가
2. 캐시 마운트 경로 수정 (/cache → 패키지 매니저별 경로)
3. finished_at 업데이트 (finish_build() 사용)
4. 컨테이너 정리 버그 수정 (old_slot 감지)
5. Docker 네트워크 모드 추가 (bridge)
6. 프록시 헤더 전달 구현
7. Glob 패턴 지원 추가 (쉼표로 여러 패턴)
8. 프로젝트 삭제 시 리소스 정리
9. nginx daemon directive 중복 제거 🆕
10. Docker 네트워크 Gateway IP 사용 🆕
11. 멀티 네트워크 컨테이너 지원 🆕

디렉토리 구조
----------------------------------
easycicd/
├── agent/                      # Rust 백엔드
│   ├── src/
│   │   ├── api/               # REST API & WebSocket
│   │   ├── build/             # 빌드 시스템
│   │   ├── db/                # 데이터베이스
│   │   ├── docker/            # Docker 클라이언트
│   │   ├── proxy/             # 리버스 프록시
│   │   ├── github/            # GitHub 통합
│   │   ├── events.rs          # 이벤트 버스
│   │   ├── state.rs           # 공유 상태
│   │   └── main.rs            # 메인 진입점
│   ├── migrations/            # DB 마이그레이션
│   ├── Dockerfile
│   └── Cargo.toml
│
├── frontend-svelte/           # Svelte 소스코드
│   ├── src/
│   │   ├── routes/           # 페이지 컴포넌트
│   │   ├── App.svelte        # 라우터
│   │   └── app.css           # 스타일
│   └── vite.config.js
│
├── frontend/                  # 빌드 결과물 (배포용)
│   ├── index.html
│   └── assets/
│
├── docker-compose.yml         # 프로덕션 Docker Compose
├── deploy.sh                  # 배포 스크립트
└── 설계 문서들


================================================================================
⚠️ 부분 구현 / 개선 필요
================================================================================

1. 실시간 로그 스트리밍
----------------------------------
현재 상태:
- 로그 파일 경로만 표시
- 실제 로그 내용 표시 안 됨

개선 방안:
- 로그 파일 읽기 API 추가 (GET /api/builds/:id/logs)
- WebSocket으로 실시간 로그 스트리밍
- 프론트엔드에서 로그 표시

2. WebSocket 실시간 업데이트
----------------------------------
현재 상태:
- 백엔드 WebSocket 서버 구현됨
- 프론트엔드에서 WebSocket 연결 구현 안 됨

개선 방안:
- Svelte 컴포넌트에서 WebSocket 연결
- 빌드 상태 변경 시 자동 UI 업데이트
- 실시간 알림 표시

3. 에러 복구 및 롤백
----------------------------------
현재 상태:
- 배포 실패 시 상태만 Failed로 변경
- 헬스체크 실패 시 컨테이너 삭제 (디버깅 모드에서는 비활성화)

개선 방안:
- Health Check 실패 시 이전 슬롯으로 자동 롤백
- 배포 실패 이력 저장
- 실패 원인 상세 로깅


================================================================================
❌ 미구현 작업 (Phase 8)
================================================================================

1. UI 개선사항
----------------------------------
필요 항목:
- Dashboard에서 프로젝트 URL 클릭 시 외부 링크로 이동
- 나머지 영역 클릭 시 빌드 상세로 이동
- 접근성 개선 (ARIA, 키보드 이벤트)

2. README 작성
----------------------------------
포함 내용:
- 프로젝트 소개
- 주요 기능
- 설치 방법
- 사용 방법
- API 문서 링크
- 아키텍처 다이어그램
- 라이선스

파일: README.md

3. 배포 가이드
----------------------------------
포함 내용:
- 시스템 요구사항
- 설치 단계별 가이드
- 환경 변수 설정
- GitHub Webhook 설정 방법
- Cloudflare Tunnel 설정
- 트러블슈팅

파일: DEPLOYMENT.md

4. 통합 테스트
----------------------------------
필요 항목:
- API 엔드포인트 테스트
- 빌드 워크플로우 E2E 테스트
- WebSocket 연결 테스트
- 리버스 프록시 테스트
- 네트워크 통신 테스트

5. CI/CD 파이프라인
----------------------------------
필요 항목:
- GitHub Actions 설정
- Docker 이미지 빌드 자동화
- 릴리스 자동화
- 버전 태깅


================================================================================
우선순위 추천
================================================================================

높음 (사용자 경험 개선):
1. Dashboard UI 개선 (URL 링크 분리)
2. 실시간 로그 스트리밍 구현
3. WebSocket 실시간 업데이트 구현

중간 (문서화):
4. README 작성
5. 기본 배포 가이드 작성
6. API 문서화

낮음 (안정성 향상):
7. 에러 복구 및 롤백 구현
8. 통합 테스트 작성
9. CI/CD 파이프라인 설정


================================================================================
알려진 제한사항
================================================================================

1. 단일 서버 환경
   - 수평 확장 불가능
   - 단일 장애점 존재

2. 로그 저장소
   - 로컬 파일 시스템에만 저장
   - 로그 순환(rotation) 없음

3. 보안
   - HTTPS는 Cloudflare Tunnel에서 처리
   - 사용자 인증 없음
   - API 키 인증 없음

4. 모니터링
   - 메트릭 수집 없음
   - 알림 시스템 없음


================================================================================
다음 단계
================================================================================

즉시 실행:
1. Dashboard URL 링크 분리 구현
2. README.md 작성
3. 실제 프로젝트로 테스트

추후 개선:
4. 로그 스트리밍 구현
5. WebSocket 실시간 업데이트
6. 에러 복구 메커니즘
7. 테스트 작성
8. 문서화 완성


================================================================================
문의 및 참고
================================================================================

설계 문서: 최종_설계_문서.txt
API 명세: API_통신_명세서.txt
오답노트: 오답노트.txt

최신 Commit: (2026-01-08)
Docker Hub: choho97/lightweight-ci:latest (sha256:319e581d0b94...)
