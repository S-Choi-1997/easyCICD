version: '3.8'

services:
  agent:
    build: ./agent
    container_name: lightweight-ci
    restart: unless-stopped

    volumes:
      # DOOD: Mount Docker socket
      - /var/run/docker.sock:/var/run/docker.sock

      # Persistent data
      - ./data:/data

    ports:
      - "3000:3000"  # API + WebSocket + Web UI
      - "8080:8080"  # Reverse Proxy (service access)

    environment:
      - DATABASE_URL=sqlite:///data/db/ci.db
      - RUST_LOG=lightweight_ci=info,tower_http=debug
      - GITHUB_WEBHOOK_SECRET=${GITHUB_WEBHOOK_SECRET:-change-me-in-production}

    networks:
      - ci-network

networks:
  ci-network:
    driver: bridge

# Runtime containers are dynamically created and managed by the agent
# They will be connected to the ci-network
