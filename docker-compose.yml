version: '3.8'

services:
  agent:
    image: choho97/lightweight-ci:latest
    container_name: easycicd-agent
    restart: unless-stopped

    # Load OAuth and other secrets from .env file
    env_file:
      - .env

    environment:
      - TZ=Asia/Seoul

    volumes:
      # DOOD: Mount Docker socket
      - /var/run/docker.sock:/var/run/docker.sock

      # Persistent data (SQLite DB & build logs)
      # IMPORTANT: Use absolute path for DOOD compatibility
      # The agent will auto-detect this path for build/runtime containers
      - ./data:/data

      # Build cache (shared across builds)
      - cache-gradle:/cache/gradle
      - cache-maven:/cache/maven
      - cache-npm:/cache/npm
      - cache-pip:/cache/pip
      - cache-cargo:/cache/cargo

      # Static frontend files
      - ./frontend:/app/frontend

    ports:
      - "10000:3000"  # API + WebSocket + Web UI
      - "9999:8080"   # Reverse Proxy (service access)

    networks:
      - easycicd

networks:
  easycicd:
    driver: bridge

volumes:
  cache-gradle:
  cache-maven:
  cache-npm:
  cache-pip:
  cache-cargo:

# Runtime containers are dynamically created and managed by the agent
# They will be connected to the easycicd network
